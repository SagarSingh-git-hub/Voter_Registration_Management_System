{% extends "base.html" %}
{% block content %}
<div class="max-w-3xl mx-auto pt-6 md:pt-10">
    <div class="glass-panel p-6 md:p-8 rounded-3xl border border-white/10 animate-slide-in">
        
        <style>
            .custom-select-container {
                position: relative;
                width: 100%;
            }

            .custom-select-trigger {
                width: 100%;
                background-color: rgba(255, 255, 255, 0.05); /* Match bg-white/5 */
                border: 1px solid rgba(255, 255, 255, 0.1);
                border-radius: 0.75rem; /* 12px */
                padding: 0.75rem 1rem; /* Match py-3 px-4 */
                color: #d1d5db; /* gray-300 */
                font-size: 1rem;
                cursor: pointer;
                transition: all 0.2s ease;
                display: flex;
                align-items: center;
                justify-content: space-between;
                user-select: none;
            }

            .custom-select-trigger.has-value {
                color: white;
            }

            .custom-select-trigger:hover {
                background-color: rgba(255, 255, 255, 0.1);
                border-color: rgba(255, 255, 255, 0.2);
            }

            .custom-select-trigger.is-open {
                border-color: #00f2ea; /* Electric Blue */
                box-shadow: 0 0 15px rgba(0, 242, 234, 0.15);
                background-color: #0F172A;
            }

            .custom-select-trigger i {
                transition: transform 0.3s ease;
                color: #6b7280;
            }

            .custom-select-trigger.is-open i {
                transform: rotate(180deg);
                color: #00f2ea;
            }

            .custom-options {
                position: absolute;
                top: calc(100% + 8px);
                left: 0;
                right: 0;
                background-color: #0F172A; /* Slate 900 - Solid Background */
                border: 1px solid rgba(255, 255, 255, 0.1);
                border-radius: 0.75rem;
                z-index: 100; /* High Z-Index */
                max-height: 300px;
                overflow-y: auto;
                opacity: 0;
                visibility: hidden;
                transform: translateY(-10px);
                transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1);
                box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.5);
                backdrop-filter: blur(12px); /* Ensure readability */
            }

            .custom-options.is-open {
                opacity: 1;
                visibility: visible;
                transform: translateY(0);
            }

            .custom-option {
                padding: 12px 16px;
                color: #e2e8f0;
                cursor: pointer;
                transition: all 0.15s ease;
                display: flex;
                align-items: center;
                justify-content: space-between;
                font-size: 0.95rem;
                border-bottom: 1px solid rgba(255, 255, 255, 0.03);
            }
            
            .custom-option:last-child {
                border-bottom: none;
            }

            .custom-option:hover {
                background-color: rgba(0, 242, 234, 0.1); /* Electric Blue with opacity */
                color: #00f2ea;
                padding-left: 20px; /* Subtle shift */
            }

            .custom-option.selected {
                background-color: rgba(0, 242, 234, 0.15);
                color: white;
                font-weight: 500;
            }
            
            .custom-option.selected::after {
                content: '\f00c';
                font-family: 'Font Awesome 5 Free';
                font-weight: 900;
                color: #00f2ea;
                font-size: 0.8rem;
            }

            /* Custom Scrollbar - Slim & Minimal */
            .custom-options::-webkit-scrollbar {
                width: 6px;
            }

            .custom-options::-webkit-scrollbar-track {
                background: transparent;
            }

            .custom-options::-webkit-scrollbar-thumb {
                background: rgba(0, 242, 234, 0.2); /* Soft Electric Blue */
                border-radius: 10px;
                transition: background 0.2s ease;
            }

            .custom-options::-webkit-scrollbar-thumb:hover {
                background: rgba(0, 242, 234, 0.5); /* Brighter on hover */
            }

            /* Firefox Scrollbar Support */
            .custom-options {
                scrollbar-width: thin;
                scrollbar-color: rgba(0, 242, 234, 0.2) transparent;
            }
        </style>
        
        <!-- Header -->
        <div class="text-center mb-8">
            <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-electric/10 text-electric mb-4 shadow-glow">
                <i class="fas fa-file-signature text-3xl"></i>
            </div>
            <h2 class="text-3xl font-display font-bold text-white mb-2">{{ service_name }}</h2>
            <p class="text-gray-400">Please fill out the details below to submit your request.</p>
        </div>

        <!-- Active Form -->
        <form class="space-y-6" method="POST">
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="space-y-2">
                    <label class="text-sm font-medium text-gray-300">Full Name</label>
                    <input type="text" name="full_name" value="{{ current_user.full_name }}" class="w-full px-4 py-3 rounded-xl bg-dark/50 border border-white/10 text-white focus:border-electric focus:ring-1 focus:ring-electric outline-none transition-all">
                </div>
                <div class="space-y-2">
                    <label class="text-sm font-medium text-gray-300">Email Address</label>
                    <input type="email" name="email" value="{{ current_user.email }}" class="w-full px-4 py-3 rounded-xl bg-dark/50 border border-white/10 text-white focus:border-electric focus:ring-1 focus:ring-electric outline-none transition-all">
                </div>
            </div>

            {% if 'search' in service_type %}
            <div class="space-y-2">
                <label class="text-sm font-medium text-gray-300">Search Query</label>
                <input type="text" name="query" placeholder="Enter Name or EPIC Number" class="w-full px-4 py-3 rounded-xl bg-dark/50 border border-white/10 text-white focus:border-electric focus:ring-1 focus:ring-electric outline-none transition-all" required>
                <p class="text-xs text-gray-500">Enter your full name or Voter ID number to search.</p>
            </div>
            
            {% elif 'complaint' in service_type %}
            <div class="space-y-2">
                <label class="text-sm font-medium text-gray-300">Subject</label>
                <select name="subject" id="complaint_subject" class="w-full px-4 py-3 rounded-xl bg-dark/50 border border-white/10 text-white focus:border-electric focus:ring-1 focus:ring-electric outline-none transition-all">
                    <option value="" disabled selected>Select Subject</option>
                    <option>Voter Card Issue</option>
                    <option>Polling Station Issue</option>
                    <option>Staff Behavior</option>
                    <option>Website/App Suggestion</option>
                    <option>Other</option>
                </select>
            </div>

            {% elif 'blo_call' in service_type %}
            <div class="space-y-2">
                <label class="text-sm font-medium text-gray-300">Preferred Date & Time</label>
                <input type="datetime-local" name="preferred_time" class="w-full px-4 py-3 rounded-xl bg-dark/50 border border-white/10 text-white focus:border-electric focus:ring-1 focus:ring-electric outline-none transition-all" required>
            </div>
            <div class="space-y-2">
                <label class="text-sm font-medium text-gray-300">Reason for Call</label>
                <select name="reason" id="blo_call_reason" class="w-full px-4 py-3 rounded-xl bg-dark/50 border border-white/10 text-white focus:border-electric focus:ring-1 focus:ring-electric outline-none transition-all">
                    <option value="" disabled selected>Select Reason</option>
                    <option>Document Verification</option>
                    <option>Address Correction</option>
                    <option>New Registration Help</option>
                    <option>Other</option>
                </select>
            </div>

            {% elif 'appeal' in service_type %}
            <div class="space-y-2">
                <label class="text-sm font-medium text-gray-300">Previous Application ID (Optional)</label>
                <input type="text" name="application_id" placeholder="e.g. APP12345" class="w-full px-4 py-3 rounded-xl bg-dark/50 border border-white/10 text-white focus:border-electric focus:ring-1 focus:ring-electric outline-none transition-all">
            </div>

            {% elif 'form7' in service_type %}
            <div class="space-y-2">
                <label class="text-sm font-medium text-gray-300">EPIC Number (Voter ID) to Delete</label>
                <input type="text" name="epic_number" placeholder="ABC1234567" class="w-full px-4 py-3 rounded-xl bg-dark/50 border border-white/10 text-white focus:border-electric focus:ring-1 focus:ring-electric outline-none transition-all" required>
            </div>
            <div class="space-y-2">
                <label class="text-sm font-medium text-gray-300">Reason for Deletion</label>
                <select name="reason" id="deletion_reason" class="w-full px-4 py-3 rounded-xl bg-dark/50 border border-white/10 text-white focus:border-electric focus:ring-1 focus:ring-electric outline-none transition-all">
                    <option value="" disabled selected>Select Reason</option>
                    <option>Expired / Deceased</option>
                    <option>Shifted Residence</option>
                    <option>Duplicate Entry</option>
                </select>
            </div>

            {% elif 'form8' in service_type %}
            <div class="space-y-2">
                <label class="text-sm font-medium text-gray-300">EPIC Number (Voter ID)</label>
                <input type="text" name="epic_number" placeholder="ABC1234567" class="w-full px-4 py-3 rounded-xl bg-dark/50 border border-white/10 text-white focus:border-electric focus:ring-1 focus:ring-electric outline-none transition-all" required>
            </div>
            <div class="space-y-2">
                <label class="text-sm font-medium text-gray-300">Correction Required In</label>
                <div class="flex flex-wrap gap-4">
                    <label class="flex items-center gap-2 text-gray-300 cursor-pointer">
                        <input type="checkbox" name="correction_fields" value="Name" class="rounded border-white/20 bg-white/5 text-electric focus:ring-electric"> Name
                    </label>
                    <label class="flex items-center gap-2 text-gray-300 cursor-pointer">
                        <input type="checkbox" name="correction_fields" value="DOB" class="rounded border-white/20 bg-white/5 text-electric focus:ring-electric"> DOB
                    </label>
                    <label class="flex items-center gap-2 text-gray-300 cursor-pointer">
                        <input type="checkbox" name="correction_fields" value="Address" class="rounded border-white/20 bg-white/5 text-electric focus:ring-electric"> Address
                    </label>
                </div>
            </div>

            {% elif 'form6a' in service_type %}
            <div class="space-y-2">
                <label class="text-sm font-medium text-gray-300">Passport Number</label>
                <input type="text" name="passport_number" placeholder="Passport No." class="w-full px-4 py-3 rounded-xl bg-dark/50 border border-white/10 text-white focus:border-electric focus:ring-1 focus:ring-electric outline-none transition-all" required>
            </div>
            <div class="space-y-2">
                <label class="text-sm font-medium text-gray-300">Country of Current Residence</label>
                <select name="country" id="country_select" class="w-full px-4 py-3 rounded-xl bg-dark/50 border border-white/10 text-white focus:border-electric focus:ring-1 focus:ring-electric outline-none transition-all">
                    <option value="" disabled selected>Select Country</option>
                    <option value="Afghanistan">Afghanistan</option>
                    <option value="Albania">Albania</option>
                    <option value="Algeria">Algeria</option>
                    <option value="American Samoa">American Samoa</option>
                    <option value="Andorra">Andorra</option>
                    <option value="Angola">Angola</option>
                    <option value="Antigua and Barbuda">Antigua and Barbuda</option>
                    <option value="Argentina">Argentina</option>
                    <option value="Armenia">Armenia</option>
                    <option value="Aruba">Aruba</option>
                    <option value="Australia">Australia</option>
                    <option value="Austria">Austria</option>
                    <option value="Azerbaijan">Azerbaijan</option>
                    <option value="The Bahamas">The Bahamas</option>
                    <option value="Bahrain">Bahrain</option>
                    <option value="Bangladesh">Bangladesh</option>
                    <option value="Barbados">Barbados</option>
                    <option value="Belarus">Belarus</option>
                    <option value="Belgium">Belgium</option>
                    <option value="Belize">Belize</option>
                    <option value="Benin">Benin</option>
                    <option value="Bermuda">Bermuda</option>
                    <option value="Bhutan">Bhutan</option>
                    <option value="Bolivia">Bolivia</option>
                    <option value="Bosnia and Herzegovina">Bosnia and Herzegovina</option>
                    <option value="Botswana">Botswana</option>
                    <option value="Brazil">Brazil</option>
                    <option value="Brunei">Brunei</option>
                    <option value="Bulgaria">Bulgaria</option>
                    <option value="Burkina Faso">Burkina Faso</option>
                    <option value="Burundi">Burundi</option>
                    <option value="Cabo Verde">Cabo Verde</option>
                    <option value="Cambodia">Cambodia</option>
                    <option value="Cameroon">Cameroon</option>
                    <option value="Canada">Canada</option>
                    <option value="Cayman Islands">Cayman Islands</option>
                    <option value="Central African Republic">Central African Republic</option>
                    <option value="Chad">Chad</option>
                    <option value="Channel Islands">Channel Islands</option>
                    <option value="Chile">Chile</option>
                    <option value="China">China</option>
                    <option value="Colombia">Colombia</option>
                    <option value="Comoros">Comoros</option>
                    <option value="Congo">Congo</option>
                    <option value="Costa Rica">Costa Rica</option>
                    <option value="Côte D'Ivoire">Côte D'Ivoire</option>
                    <option value="Croatia">Croatia</option>
                    <option value="Cuba">Cuba</option>
                    <option value="Curaçao">Curaçao</option>
                    <option value="Cyprus">Cyprus</option>
                    <option value="Czech Republic">Czech Republic</option>
                    <option value="Dem. People's Rep. Korea">Dem. People's Rep. Korea</option>
                    <option value="Dem. Rep. Congo">Dem. Rep. Congo</option>
                    <option value="Denmark">Denmark</option>
                    <option value="Djibouti">Djibouti</option>
                    <option value="Dominica">Dominica</option>
                    <option value="Dominican Republic">Dominican Republic</option>
                    <option value="Ecuador">Ecuador</option>
                    <option value="Egypt">Egypt</option>
                    <option value="El Salvador">El Salvador</option>
                    <option value="Equatorial Guinea">Equatorial Guinea</option>
                    <option value="Eritrea">Eritrea</option>
                    <option value="Estonia">Estonia</option>
                    <option value="Ethiopia">Ethiopia</option>
                    <option value="Faeroe Islands">Faeroe Islands</option>
                    <option value="Fiji">Fiji</option>
                    <option value="Finland">Finland</option>
                    <option value="France">France</option>
                    <option value="French Guiana">French Guiana</option>
                    <option value="French Polynesia">French Polynesia</option>
                    <option value="Gabon">Gabon</option>
                    <option value="The Gambia">The Gambia</option>
                    <option value="Georgia">Georgia</option>
                    <option value="Germany">Germany</option>
                    <option value="Ghana">Ghana</option>
                    <option value="Greece">Greece</option>
                    <option value="Greenland">Greenland</option>
                    <option value="Grenada">Grenada</option>
                    <option value="Guadeloupe (French)">Guadeloupe (French)</option>
                    <option value="Guam">Guam</option>
                    <option value="Guatemala">Guatemala</option>
                    <option value="Guinea">Guinea</option>
                    <option value="Guinea-Bissau">Guinea-Bissau</option>
                    <option value="Guyana">Guyana</option>
                    <option value="Haiti">Haiti</option>
                    <option value="Honduras">Honduras</option>
                    <option value="Hong Kong SAR, China">Hong Kong SAR, China</option>
                    <option value="Hungary">Hungary</option>
                    <option value="Iceland">Iceland</option>
                    <option value="India">India</option>
                    <option value="Indonesia">Indonesia</option>
                    <option value="Iran">Iran</option>
                    <option value="Iraq">Iraq</option>
                    <option value="Ireland">Ireland</option>
                    <option value="Isle of Man">Isle of Man</option>
                    <option value="Israel">Israel</option>
                    <option value="Italy">Italy</option>
                    <option value="Jamaica">Jamaica</option>
                    <option value="Japan">Japan</option>
                    <option value="Jordan">Jordan</option>
                    <option value="Kazakhstan">Kazakhstan</option>
                    <option value="Kenya">Kenya</option>
                    <option value="Kiribati">Kiribati</option>
                    <option value="Korea">Korea</option>
                    <option value="Kosovo">Kosovo</option>
                    <option value="Kuwait">Kuwait</option>
                    <option value="Kyrgyz Republic">Kyrgyz Republic</option>
                    <option value="Lao PDR">Lao PDR</option>
                    <option value="Latvia">Latvia</option>
                    <option value="Lebanon">Lebanon</option>
                    <option value="Lesotho">Lesotho</option>
                    <option value="Liberia">Liberia</option>
                    <option value="Libya">Libya</option>
                    <option value="Liechtenstein">Liechtenstein</option>
                    <option value="Lithuania">Lithuania</option>
                    <option value="Luxembourg">Luxembourg</option>
                    <option value="Macao SAR, China">Macao SAR, China</option>
                    <option value="Macedonia">Macedonia</option>
                    <option value="Madagascar">Madagascar</option>
                    <option value="Malawi">Malawi</option>
                    <option value="Malaysia">Malaysia</option>
                    <option value="Maldives">Maldives</option>
                    <option value="Mali">Mali</option>
                    <option value="Malta">Malta</option>
                    <option value="Marshall Islands">Marshall Islands</option>
                    <option value="Martinique (French)">Martinique (French)</option>
                    <option value="Mauritania">Mauritania</option>
                    <option value="Mauritius">Mauritius</option>
                    <option value="Mexico">Mexico</option>
                    <option value="Micronesia">Micronesia</option>
                    <option value="Moldova">Moldova</option>
                    <option value="Monaco">Monaco</option>
                    <option value="Mongolia">Mongolia</option>
                    <option value="Montenegro">Montenegro</option>
                    <option value="Morocco">Morocco</option>
                    <option value="Mozambique">Mozambique</option>
                    <option value="Myanmar">Myanmar</option>
                    <option value="Namibia">Namibia</option>
                    <option value="Nepal">Nepal</option>
                    <option value="Netherlands">Netherlands</option>
                    <option value="New Caledonia">New Caledonia</option>
                    <option value="New Zealand">New Zealand</option>
                    <option value="Nicaragua">Nicaragua</option>
                    <option value="Niger">Niger</option>
                    <option value="Nigeria">Nigeria</option>
                    <option value="Northern Mariana Islands">Northern Mariana Islands</option>
                    <option value="Norway">Norway</option>
                    <option value="Oman">Oman</option>
                    <option value="Pacific Islands">Pacific Islands</option>
                    <option value="Pakistan">Pakistan</option>
                    <option value="Palau">Palau</option>
                    <option value="Panama">Panama</option>
                    <option value="Papua New Guinea">Papua New Guinea</option>
                    <option value="Paraguay">Paraguay</option>
                    <option value="Peru">Peru</option>
                    <option value="Philippines">Philippines</option>
                    <option value="Poland">Poland</option>
                    <option value="Portugal">Portugal</option>
                    <option value="Puerto Rico">Puerto Rico</option>
                    <option value="Qatar">Qatar</option>
                    <option value="Reunion (French)">Reunion (French)</option>
                    <option value="Romania">Romania</option>
                    <option value="Russia">Russia</option>
                    <option value="Rwanda">Rwanda</option>
                    <option value="Samoa">Samoa</option>
                    <option value="San Marino">San Marino</option>
                    <option value="São Tomé and Principe">São Tomé and Principe</option>
                    <option value="Saudi Arabia">Saudi Arabia</option>
                    <option value="Senegal">Senegal</option>
                    <option value="Serbia">Serbia</option>
                    <option value="Seychelles">Seychelles</option>
                    <option value="Sierra Leone">Sierra Leone</option>
                    <option value="Singapore">Singapore</option>
                    <option value="Sint Maarten (Dutch part)">Sint Maarten (Dutch part)</option>
                    <option value="Slovak Republic">Slovak Republic</option>
                    <option value="Slovenia">Slovenia</option>
                    <option value="Solomon Islands">Solomon Islands</option>
                    <option value="Somalia">Somalia</option>
                    <option value="South Africa">South Africa</option>
                    <option value="South Sudan">South Sudan</option>
                    <option value="Spain">Spain</option>
                    <option value="Sri Lanka">Sri Lanka</option>
                    <option value="St. Kitts and Nevis">St. Kitts and Nevis</option>
                    <option value="St. Lucia">St. Lucia</option>
                    <option value="St. Martin (French part)">St. Martin (French part)</option>
                    <option value="St. Vincent and the Grenadines">St. Vincent and the Grenadines</option>
                    <option value="Sudan">Sudan</option>
                    <option value="Suriname">Suriname</option>
                    <option value="Swaziland">Swaziland</option>
                    <option value="Sweden">Sweden</option>
                    <option value="Switzerland">Switzerland</option>
                    <option value="Syrian Arab Republic">Syrian Arab Republic</option>
                    <option value="Taiwan">Taiwan</option>
                    <option value="Tajikistan">Tajikistan</option>
                    <option value="Tanzania">Tanzania</option>
                    <option value="Thailand">Thailand</option>
                    <option value="Timor-Leste">Timor-Leste</option>
                    <option value="Togo">Togo</option>
                    <option value="Tonga">Tonga</option>
                    <option value="Trinidad and Tobago">Trinidad and Tobago</option>
                    <option value="Tunisia">Tunisia</option>
                    <option value="Turkey">Turkey</option>
                    <option value="Turkmenistan">Turkmenistan</option>
                    <option value="Turks and Caicos Islands">Turks and Caicos Islands</option>
                    <option value="Tuvalu">Tuvalu</option>
                    <option value="Uganda">Uganda</option>
                    <option value="Ukraine">Ukraine</option>
                    <option value="United Arab Emirates">United Arab Emirates</option>
                    <option value="United Kingdom">United Kingdom</option>
                    <option value="United States">United States</option>
                    <option value="Uruguay">Uruguay</option>
                    <option value="Uzbekistan">Uzbekistan</option>
                    <option value="Vanuatu">Vanuatu</option>
                    <option value="Vatican">Vatican</option>
                    <option value="Venezuela">Venezuela</option>
                    <option value="Vietnam">Vietnam</option>
                    <option value="Virgin Islands">Virgin Islands</option>
                    <option value="West Bank & Gaza (Palestinian Authority)">West Bank & Gaza (Palestinian Authority)</option>
                    <option value="Yemen">Yemen</option>
                    <option value="Zambia">Zambia</option>
                    <option value="Zimbabwe">Zimbabwe</option>
                </select>
            </div>
            {% endif %}

            {% if 'search' not in service_type %}
            <div class="space-y-2">
                <label class="text-sm font-medium text-gray-300">Additional Comments / Details</label>
                <textarea name="details" rows="4" class="w-full px-4 py-3 rounded-xl bg-dark/50 border border-white/10 text-white focus:border-electric focus:ring-1 focus:ring-electric outline-none transition-all"></textarea>
            </div>
            {% endif %}

            <div class="flex items-center gap-4 pt-4">
                <a href="{{ url_for('main.dashboard') }}" class="flex-1 px-6 py-3 rounded-xl border border-white/10 text-center font-bold text-gray-300 hover:bg-white/5 transition-all">Cancel</a>
                <button type="submit" class="flex-1 px-6 py-3 rounded-xl bg-electric text-dark font-bold hover:bg-white transition-all shadow-glow">
                    {% if 'search' in service_type %} Search Records {% else %} Submit Application {% endif %}
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize Custom Selects
        function initCustomSelect(nativeSelectId, placeholder) {
            const nativeSelect = document.getElementById(nativeSelectId);
            if (!nativeSelect) return;

            // Hide native select
            nativeSelect.style.display = 'none';
            
            // Create Container
            const container = document.createElement('div');
            container.className = 'custom-select-container';
            nativeSelect.parentNode.insertBefore(container, nativeSelect);
            container.appendChild(nativeSelect); // Move native select inside

            // Create Trigger
            const trigger = document.createElement('div');
            trigger.className = 'custom-select-trigger';
            trigger.setAttribute('tabindex', '0'); // Enable keyboard focus
            
            // Determine initial text
            let initialText = placeholder;
            if (nativeSelect.selectedIndex >= 0 && nativeSelect.options[nativeSelect.selectedIndex].value) {
                initialText = nativeSelect.options[nativeSelect.selectedIndex].text;
                trigger.classList.add('has-value');
            }
            
            trigger.innerHTML = `<span>${initialText}</span><i class="fas fa-chevron-down"></i>`;
            container.appendChild(trigger);

            // Create Options Container
            const optionsContainer = document.createElement('div');
            optionsContainer.className = 'custom-options';
            container.appendChild(optionsContainer);

            let focusedIndex = -1;

            // Helper to toggle state
            function setOpen(isOpen) {
                if (isOpen) {
                    container.classList.add('is-active');
                    optionsContainer.classList.add('is-open');
                    trigger.classList.add('is-open');
                    
                    // Reset focus index based on selection
                    const selected = optionsContainer.querySelector('.custom-option.selected');
                    const allOptions = Array.from(optionsContainer.querySelectorAll('.custom-option'));
                    if (selected) {
                        focusedIndex = allOptions.indexOf(selected);
                    } else {
                        focusedIndex = -1;
                    }
                    if (focusedIndex >= 0) highlightOption(focusedIndex);

                } else {
                    // Delay removing z-index to allow animation to finish
                    setTimeout(() => container.classList.remove('is-active'), 200);
                    optionsContainer.classList.remove('is-open');
                    trigger.classList.remove('is-open');
                    focusedIndex = -1;
                    clearHighlights();
                }
            }

            function highlightOption(index) {
                const allOptions = optionsContainer.querySelectorAll('.custom-option');
                allOptions.forEach((opt, i) => {
                    if (i === index) {
                        opt.classList.add('focused');
                        opt.scrollIntoView({ block: 'nearest' });
                    } else {
                        opt.classList.remove('focused');
                    }
                });
            }

            function clearHighlights() {
                optionsContainer.querySelectorAll('.custom-option').forEach(o => o.classList.remove('focused'));
            }

            // Toggle Dropdown
            trigger.addEventListener('click', (e) => {
                e.stopPropagation();
                
                // Close other dropdowns
                document.querySelectorAll('.custom-options').forEach(opt => {
                    if (opt !== optionsContainer) {
                        opt.classList.remove('is-open');
                        opt.previousElementSibling.classList.remove('is-open');
                        const otherContainer = opt.closest('.custom-select-container');
                        if (otherContainer) otherContainer.classList.remove('is-active');
                    }
                });

                const willOpen = !optionsContainer.classList.contains('is-open');
                setOpen(willOpen);
            });

            // Keyboard Navigation
            trigger.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    if (optionsContainer.classList.contains('is-open')) {
                        if (focusedIndex >= 0) {
                            const allOptions = optionsContainer.querySelectorAll('.custom-option');
                            if (allOptions[focusedIndex]) allOptions[focusedIndex].click();
                        } else {
                            setOpen(false);
                        }
                    } else {
                        setOpen(true);
                    }
                } else if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    if (!optionsContainer.classList.contains('is-open')) setOpen(true);
                    const allOptions = optionsContainer.querySelectorAll('.custom-option');
                    if (focusedIndex < allOptions.length - 1) {
                        focusedIndex++;
                        highlightOption(focusedIndex);
                    }
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    if (!optionsContainer.classList.contains('is-open')) setOpen(true);
                    if (focusedIndex > 0) {
                        focusedIndex--;
                        highlightOption(focusedIndex);
                    }
                } else if (e.key === 'Escape') {
                    setOpen(false);
                    trigger.focus();
                } else if (e.key === 'Tab') {
                    setOpen(false);
                }
            });

            // Close when clicking outside
            document.addEventListener('click', (e) => {
                if (!container.contains(e.target)) {
                    if (optionsContainer.classList.contains('is-open')) {
                        setOpen(false);
                    }
                }
            });

            // Expose update function to refresh options from native select
            container.updateOptions = function() {
                optionsContainer.innerHTML = '';
                
                Array.from(nativeSelect.options).forEach(opt => {
                    if (opt.disabled || opt.value === "") return;

                    const customOption = document.createElement('div');
                    customOption.className = 'custom-option';
                    customOption.textContent = opt.text;
                    customOption.dataset.value = opt.value;
                    
                    if (opt.selected) {
                        customOption.classList.add('selected');
                    }

                    customOption.addEventListener('click', (e) => {
                        e.stopPropagation();
                        // Update Native Select
                        nativeSelect.value = customOption.dataset.value;
                        
                        // Trigger Change Event on Native Select
                        const event = new Event('change', { bubbles: true });
                        nativeSelect.dispatchEvent(event);

                        // Update Trigger UI
                        trigger.querySelector('span').textContent = customOption.textContent;
                        trigger.classList.add('has-value');
                        
                        // Close Dropdown
                        setOpen(false);
                        
                        // Update Selection Styling
                        optionsContainer.querySelectorAll('.custom-option').forEach(o => o.classList.remove('selected'));
                        customOption.classList.add('selected');
                        trigger.focus();
                    });

                    // Mouse interaction
                    customOption.addEventListener('mouseenter', () => {
                        const allOptions = Array.from(optionsContainer.querySelectorAll('.custom-option'));
                        focusedIndex = allOptions.indexOf(customOption);
                        clearHighlights();
                        customOption.classList.add('focused');
                    });

                    optionsContainer.appendChild(customOption);
                });
            };

            // Initial population
            container.updateOptions();

            return container;
        }

        // Initialize UI wrappers
        initCustomSelect('complaint_subject', 'Select Subject');
        initCustomSelect('blo_call_reason', 'Select Reason');
        initCustomSelect('deletion_reason', 'Select Reason');
        initCustomSelect('country_select', 'Select Country');
    });
</script>
{% endblock %}
